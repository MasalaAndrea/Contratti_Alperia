<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore PDF Alperia - Dati Cliente</title>
    <link rel="stylesheet" href="style.css">
    <style>
    .autocomplete-suggestions {
      border: 1px solid #999; max-height: 170px; overflow-y: auto;
      background: #fffbcc;
      position: absolute; z-index: 99; width: 100%;
    }
    .autocomplete-suggestion {
      padding: 6px 10px; cursor: pointer;
    }
    .autocomplete-suggestion:hover {
      background: #e2e2ff;
    }
    .autocomplete-group { position: relative; }
    </style>
</head>
<body class="residenziale">
    <header class="main-header">
        <div class="header-content">
            <img src="logo-menergy.png" alt="M-Energy Logo" class="logo logo-sinistra">
            <img src="logo-alperia.png" alt="Alperia Logo" class="logo logo-destra">
        </div>
    </header>
    <div class="card-centrale">
        <h1 class="titolo-contratto">Contratto Residenziale</h1>
        <div class="sottotitolo"><b>Pagina 1 di 3:</b> Dati Cliente</div>
        <form id="customerForm">
            <div class="form-section">
                <h3>Dati del Cliente</h3>
                <div class="form-group-doppio">
                    <div class="form-group">
                        <label for="cognome">Cognome:*</label>
                        <input type="text" id="cognome" name="cognome" required>
                    </div>
                    <div class="form-group">
                        <label for="nome">Nome:*</label>
                        <input type="text" id="nome" name="nome" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="cf">Codice Fiscale:*</label>
                    <input type="text" id="cf" name="cf" required maxlength="16" minlength="16">
                    <div id="cf-error" class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="indirizzo_residenza">Indirizzo di residenza:*</label>
                    <input type="text" id="indirizzo_residenza" name="indirizzo_residenza" required>
                </div>
                <div class="form-group-doppio">
                    <div class="form-group">
                        <label for="n_residenza">N:*</label>
                        <input type="text" id="n_residenza" name="n_residenza" required>
                    </div>
                    <div class="form-group">
                        <label for="cap_residenza">CAP:*</label>
                        <input type="text" id="cap_residenza" required maxlength="5" minlength="5">
                        <div id="cap_residenza-error" class="error-message"></div>
                    </div>
                </div>
                <div class="form-group-doppio">
                    <div class="form-group autocomplete-group">
                        <label for="comune_residenza">Comune:*</label>
                        <input type="text" id="comune_residenza" name="comune_residenza" required autocomplete="off">
                        <div id="suggestions_residenza" class="autocomplete-suggestions" style="display:none"></div>
                    </div>
                    <div class="form-group">
                        <label for="provincia_residenza">Provincia:*</label>
                        <input type="text" id="provincia_residenza" name="provincia_residenza" required maxlength="2" minlength="2">
                    </div>
                </div>
                <div class="form-group">
                    <label for="cellulare">Cellulare:*</label>
                    <input type="tel" id="cellulare" name="cellulare" required>
                </div>
                <div class="form-group">
                    <label for="mail">E-mail:*</label>
                    <input type="email" id="mail" name="mail" required>
                </div>
                <!-- INIZIO AGGIUNTA: Residente presso la fornitura -->
                <div class="form-group">
                    <label style="font-weight:500; color:#1c3664; margin-bottom:6px;">
                        Residente presso la fornitura*
                    </label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="residente_fornitura" value="si" id="residente_si" required>
                            SI
                        </label>
                        <label>
                            <input type="radio" name="residente_fornitura" value="no" id="residente_no">
                            NO
                        </label>
                    </div>
                </div>
            <div class="form-section">
                <h3>Dati di Fornitura</h3>
                <div class="checkbox-group">
                    <input type="checkbox" id="fornitura_diversa" name="fornitura_diversa">
                    <label for="fornitura_diversa">Indirizzo di fornitura diverso dalla residenza</label>
                </div>
                <div id="dati-fornitura" style="display: none;">
                    <div class="form-group">
                        <label for="indirizzo_fornitura">Indirizzo:*</label>
                        <input type="text" id="indirizzo_fornitura" name="indirizzo_fornitura" class="fornitura-obbligatoria">
                    </div>
                    <div class="form-group-doppio">
                        <div class="form-group">
                            <label for="n_fornitura">N:*</label>
                            <input type="text" id="n_fornitura" name="n_fornitura" class="fornitura-obbligatoria">
                        </div>
                        <div class="form-group">
                            <label for="cap_fornitura">CAP:*</label>
                            <input type="text" id="cap_fornitura" name="cap_fornitura" class="fornitura-obbligatoria" required maxlength="5" minlength="5">
                        </div>
                    </div>
                    <div class="form-group-doppio">
                        <div class="form-group autocomplete-group">
                            <label for="comune_fornitura">Comune:*</label>
                            <input type="text" id="comune_fornitura" name="comune_fornitura" class="fornitura-obbligatoria" autocomplete="off">
                            <div id="suggestions_fornitura" class="autocomplete-suggestions" style="display:none"></div>
                        </div>
                        <div class="form-group">
                            <label for="provincia_fornitura">Provincia:*</label>
                            <input type="text" id="provincia_fornitura" name="provincia_fornitura" class="fornitura-obbligatoria" required maxlength="2" minlength="2">
                        </div>
                    </div>
                </div>
            </div>
              <div class="navigation-buttons">
               <button type="button" onclick="window.history.back()">Indietro</button>
               <button type="button" onclick="window.location.href='index.html'" class="home-btn-navi">Home</button>
               <button type="submit">Avanti</button>
            </div>
        </form>
    </div>
    <footer class="main-footer">
    © 2025 M-ENERGY | <a href="#">Privacy</a> | <a href="#" id="contatti-link">Contatti</a>
    </footer>
    <script>
    document.getElementById('fornitura_diversa').addEventListener('change', function(e) {
        document.getElementById('dati-fornitura').style.display = e.target.checked ? 'block' : 'none';
    });
    </script>
    <script src="script.js"></script>
    <!-- MODAL CONTATTI -->
<div id="contatti-modal" class="contatti-modal" style="display:none;">
    <div class="contatti-modal-content">
        <span class="contatti-close" id="contatti-close">&times;</span>
        <h3>Contatti</h3>
        <p><strong>Masala Andrea</strong></p>
        <p>
            <a href="https://masalaenergia.it" target="_blank">masalaenergia.it</a><br>
            <a href="mailto:info@masalaenergia.it">info@masalaenergia.it</a>
        </p>
        <hr style="margin:18px 0 12px 0;">
        <div class="contatti-version">
            <span class="contatti-ver-ico">&#128187;</span>
            <span>Ver 2.0.0</span>
        </div>
    </div>
</div>
<!-- AUTOCOMPLETE JS perfezionato + AUTO-COMPILAZIONE DA CAP -->
<script>
const comuniPromise = fetch('data/comuni.json').then(r => r.json());

function setupComuneAutocomplete(inputComuneId, inputCapId, inputProvinciaId, suggestionBoxId) {
    let inputComune = document.getElementById(inputComuneId);
    let inputCap = document.getElementById(inputCapId);
    let inputProvincia = document.getElementById(inputProvinciaId);
    let suggestions = document.getElementById(suggestionBoxId);

    inputComune.addEventListener('input', function() {
        const val = this.value.trim().toLowerCase();
        suggestions.innerHTML = '';
        comuniPromise.then(function(comuni) {
            if (!val || !comuni || comuni.length === 0) {
                suggestions.style.display = 'none';
                return;
            }
            // PRIMA quelli che iniziano con la stringa digitata, POI quelli che la contengono
            let startsWith = comuni.filter(c => c.nome.toLowerCase().startsWith(val));
            let contains = comuni.filter(c => !c.nome.toLowerCase().startsWith(val) && c.nome.toLowerCase().includes(val));
            let filtered = startsWith.concat(contains).slice(0, 20);
            if (filtered.length === 0) {
                suggestions.style.display = 'none';
                return;
            }
            filtered.forEach(c => {
                let capText = (c.cap && c.cap.length > 1) ? ' [' + c.cap.join(', ') + ']' : (c.cap && c.cap.length === 1 ? ' [' + c.cap[0] + ']' : '');
                let div = document.createElement('div');
                div.className = 'autocomplete-suggestion';
                div.textContent = c.nome + ' (' + c.sigla + ')' + capText;
                div.onclick = () => {
                    inputComune.value = c.nome;
                    if (inputCap) inputCap.value = (c.cap && c.cap.length > 0) ? c.cap[0] : '';
                    if (inputProvincia) inputProvincia.value = c.sigla;
                    suggestions.style.display = 'none';
                };
                suggestions.appendChild(div);
            });
            suggestions.style.display = 'block';
        });
    });

    document.addEventListener('click', function(e) {
        if (e.target !== inputComune) {
            suggestions.style.display = 'none';
        }
    });

    // AUTO-COMPILAZIONE DA CAP
    if (inputCap) {
        inputCap.addEventListener('input', function() {
            const val = this.value.trim();
            if (val.length === 5) {
                comuniPromise.then(comuni => {
                    let matchingComuni = comuni.filter(c => c.cap && c.cap.includes(val));
                    if (matchingComuni.length === 1) {
                        inputComune.value = matchingComuni[0].nome;
                        if (inputProvincia) inputProvincia.value = matchingComuni[0].sigla;
                    } else if (matchingComuni.length > 1) {
                        // Se più comuni trovati con lo stesso CAP, scegli il primo (opzionale: mostra una select)
                        inputComune.value = matchingComuni[0].nome;
                        if (inputProvincia) inputProvincia.value = matchingComuni[0].sigla;
                    }
                });
            }
        });
    }
}

// Attiva autocomplete e auto-compilazione CAP su entrambi i gruppi
setupComuneAutocomplete('comune_residenza', 'cap_residenza', 'provincia_residenza', 'suggestions_residenza');
setupComuneAutocomplete('comune_fornitura', 'cap_fornitura', 'provincia_fornitura', 'suggestions_fornitura');
</script>
</body>
</html>