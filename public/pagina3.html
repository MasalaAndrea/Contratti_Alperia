<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore PDF Alperia - Pagamento e Consensi</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .section-box {
            background: #f9fafd;
            border: 2px solid #d1e4f6;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(30,80,140,0.07);
            padding: 26px 20px 20px 20px;
            margin-bottom: 28px;
        }
        .section-box h3 {
            margin-top: 0;
            margin-bottom: 16px;
            color: #1c3664;
        }
        .error-border {
            border: 2px solid #e94d4d !important;
        }
        .error-message {
            color: #e94d4d;
            font-size: 0.9em;
            margin-top: 2px;
        }
        @media (max-width: 700px) {
            .section-box {
                padding: 12px 6px 8px 6px;
            }
        }
        .firma-extra-label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #0a3a50;
        }
        .firma-seconda {
            margin-top: 10px;
        }
    </style>
</head>
<body class="residenziale">
<div class="container">
    <h1>Contratto residenziale</h1>
    <h2>Pagina 3 di 3: Pagamento e Consensi</h2>
    <form id="paymentForm" novalidate>
        <div class="form-section section-box">
            <h3>Autorizzazione Addebito Diretto (SDD)*</h3>
            <div class="form-group">
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="autorizzazione_sdd" name="autorizzazione_sdd">
                        Autorizzazione addebito diretto in conto corrente.
                        In caso di debbitore diverso dall’intestatario del contratto è richiesta la firma 
                    </label>
                </div>
            </div>
            <div id="sezione-sdd" style="display: none;">
                <div class="form-group">
                    <label for="cognome_nome">Cognome e Nome debitore:*</label>
                    <input type="text" id="cognome_nome" name="cognome_nome">
                </div>
                <div class="form-group">
                    <label for="indirizzo_debitore">Indirizzo debitore:*</label>
                    <input type="text" id="indirizzo_debitore" name="indirizzo_debitore">
                </div>
                <div class="form-group">
                    <label for="cf_debitore">Partiva Iva/Codice Fiscale debitore:*</label>
                    <input type="text" id="cf_debitore" name="cf_debitore" maxlength="16" minlength="11">
                    <div id="cf_debitore-error" class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="iban">IBAN:*</label>
                    <input type="text" id="iban" name="iban" maxlength="27" minlength="27">
                    <div id="iban-error" class="error-message"></div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="debitore_diverso" name="debitore_diverso">
                        Il debitore è diverso dall’intestatario del contratto (richiede firma debitore)
                    </label>
                </div>
                <div class="form-group firma-seconda" id="firma-debitore-sdd-group" style="display:none;">
                    <div class="firma-extra-label">Firma del debitore SDD:*</div>
                    <canvas id="firma-debitore-sdd-pad" class="firma-canvas" width="900" height="300"></canvas>
                    <div class="text-center">
                        <button type="button" id="clear-firma-debitore-sdd">Cancella Firma</button>
                    </div>
                    <div class="error-message" id="firma-debitore-sdd-error"></div>
                </div>
            </div>
        </div>
        <div class="form-section section-box">
            <h3>Consensi</h3>
            <div class="checkbox-group">
                <label>
                    <input type="checkbox" id="consenso_obbligatorio" name="consenso_obbligatorio" checked disabled>
                    Presa visione dell’Informativa sulla Privacy e rilascio del consenso al trattamento dei dati personali per le finalità legate all’erogazione del servizio.
                </label>
                <label>
                    <input type="checkbox" id="consenso_promozione" name="consenso_promozione">
                    Consenso al trattamento dei dati personali per finalità di promozione e marketing
                </label>
                <label>
                    <input type="checkbox" id="consenso_profilazione" name="consenso_profilazione">
                    Consenso al trattamento dei dati personali per finalità di profilazione
                </label>
                <label>
                    <input type="checkbox" id="consenso_terzi" name="consenso_terzi">
                    Consenso alla comunicazione dei dati personali a terzi per le medesime finalità di cui ai punti precedenti.
                </label>
            </div>
        </div>
        <div class="form-section section-box">
            <h3>Dichiarazioni*</h3>
            <div class="radio-group">
                <label>
                    <input type="radio" name="dichiarazione" value="proprietario">
                    Dichiara di essere il proprietario dell’immobile
                </label>
                <label>
                    <input type="radio" name="dichiarazione" value="affitto">
                    Dichiara di essere in affitto/locazione
                </label>
            </div>
        </div>
        <div class="form-section section-box">
            <h3>Documento d'Identità*</h3>
            <div class="checkbox-group">
                <label>
                    <input type="checkbox" id="carta_identita" name="documento_identita" value="Carta d'identità">
                    Carta d'identità
                </label>
                <label>
                    <input type="checkbox" id="patente" name="documento_identita" value="Patente">
                    Patente
                </label>
                <label>
                    <input type="checkbox" id="passaporto" name="documento_identita" value="Passaporto">
                    Passaporto
                </label>
            </div>
        </div>
        <div class="form-section">
            <h2>Data e Firma*</h2>
            <div class="form-group">
                <label for="data_firma">Data:*</label>
                <input type="date" id="data_firma" name="data_firma" required>
            </div>
           <div class="form-group">
    <label>Firma:*</label>
    <canvas id="firma-pad" class="firma-canvas"></canvas>
    <div class="text-center">
        <button type="button" id="clear-firma">Cancella Firma</button>
    </div>
</div>
        </div>
        <div class="navigation-buttons">
               <button type="button" onclick="window.history.back()">Indietro</button>
               <button type="button" onclick="window.location.href='index.html'" class="home-btn-navi">Home</button>
               <button type="submit">Avanti</button>
            </div>
    </form>
</div>
<footer class="main-footer">
    © 2025 M-ENERGY | <a href="#">Privacy</a> | <a href="#" id="contatti-link">Contatti</a>
</footer>
<script src="firma.js"></script>
<script src="script.js"></script>
<!-- MODAL CONTATTI -->
<div id="contatti-modal" class="contatti-modal" style="display:none;">
    <div class="contatti-modal-content">
        <span class="contatti-close" id="contatti-close">&times;</span>
        <h3>Contatti</h3>
        <p><strong>Masala Andrea</strong></p>
        <p>
            <a href="https://masalaenergia.it" target="_blank">masalaenergia.it</a><br>
            <a href="mailto:info@masalaenergia.it">info@masalaenergia.it</a>
        </p>
        <hr style="margin:18px 0 12px 0;">
        <div class="contatti-version">
            <span class="contatti-ver-ico">&#128187;</span>
            <span>Ver 2.0.0</span>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var debitoreDiversoCheckbox = document.getElementById('debitore_diverso');
    var firmaDebitGroup = document.getElementById('firma-debitore-sdd-group');
    var firmaDebitoreAvviata = false;
    var paymentForm = document.getElementById('paymentForm');
    var canvasFirmaDebitore = document.getElementById('firma-debitore-sdd-pad');
    var firmaSDDError = document.getElementById('firma-debitore-sdd-error');

    if(debitoreDiversoCheckbox && firmaDebitGroup) {
        debitoreDiversoCheckbox.addEventListener('change', function() {
            if(this.checked) {
                firmaDebitGroup.style.display = 'block';
                if (typeof window.initFirmaPad === "function" && !firmaDebitoreAvviata) {
                    window.initFirmaPad('firma-debitore-sdd-pad', 'clear-firma-debitore-sdd');
                    firmaDebitoreAvviata = true;
                }
            } else {
                firmaDebitGroup.style.display = 'none';
                if (firmaSDDError) firmaSDDError.textContent = '';
                if (canvasFirmaDebitore) canvasFirmaDebitore.style.border = "2px solid #aaa";
            }
        });
    }
    if(debitoreDiversoCheckbox && firmaDebitGroup && debitoreDiversoCheckbox.checked) {
        firmaDebitGroup.style.display = 'block';
    }

    function isCanvasBlank(canvas) {
        if (!canvas) return true;
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const pixelBuffer = new Uint32Array(
            ctx.getImageData(0, 0, canvas.width, canvas.height).data.buffer
        );
        return !pixelBuffer.some(color => color !== 0);
    }

    if (paymentForm) {
        paymentForm.addEventListener('submit', function(event) {
            event.preventDefault();

            let errore = false;

            // Validazione campo data obbligatoria
            var dataFirmaInput = document.getElementById('data_firma');
            if (!dataFirmaInput.value) {
                errore = true;
                dataFirmaInput.classList.add('error-border');
                alert("Devi selezionare la data per proseguire.");
                dataFirmaInput.focus();
            } else {
                dataFirmaInput.classList.remove('error-border');
            }

            // Controllo firma debitore diverso SDD obbligatoria
            if (debitoreDiversoCheckbox && debitoreDiversoCheckbox.checked && canvasFirmaDebitore) {
                if (isCanvasBlank(canvasFirmaDebitore)) {
                    errore = true;
                    if (firmaSDDError) firmaSDDError.textContent = "La firma del debitore è obbligatoria.";
                    canvasFirmaDebitore.style.border = "2px solid #e94d4d";
                    alert("Devi inserire la firma del debitore SDD per proseguire.");
                    canvasFirmaDebitore.scrollIntoView({ behavior: "smooth", block: "center" });
                } else {
                    if (firmaSDDError) firmaSDDError.textContent = '';
                    canvasFirmaDebitore.style.border = "2px solid #aaa";
                }
            }
            // ... altri controlli obbligatori qui ...

            if (errore) {
                return;
            }

            // ... continua con il salvataggio dei dati e navigazione ...
            // (questo blocco viene gestito in script.js, quindi qui solo la validazione extra se serve)
        });
    }

    // Pulizia errore quando si firma
    if (canvasFirmaDebitore) {
        canvasFirmaDebitore.addEventListener('mouseup', function() {
            if (!isCanvasBlank(canvasFirmaDebitore)) {
                if (firmaSDDError) firmaSDDError.textContent = "";
                canvasFirmaDebitore.style.border = "2px solid #aaa";
            }
        });
    }
});
</script>
</body>
</html>